<!doctype html>
<html lang="it">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="theme-color" content="#36a763" />
        <title>Ordini di Lavoro - Piduemme</title>
        <!-- Font Ubuntu con Light weight -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
        <!-- Stili -->
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="themes.css" />
        <link rel="manifest" href="manifest.json" />
        <!-- Libreria per scansione barcode -->
        <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    </head>
    <body>
        <!-- HEADER -->
        <header class="header">
            <div class="header-left">
                <h1>üè≠ <span class="highlight">Ordini di Lavoro</span></h1>
            </div>
            <div class="header-right">
                <!-- THEME SELECTOR -->
                <div class="theme-selector" id="themeSelector">
                    <button class="theme-selector-btn" id="themeSelectorBtn" title="Cambia stile">
                        <span class="theme-icon">üé®</span>
                        <span class="theme-name" id="currentThemeName">Originale</span>
                    </button>
                    <div class="theme-dropdown" id="themeDropdown">
                        <button class="theme-option active" data-style="default">
                            <span class="theme-preview"></span>
                            <span>Originale</span>
                        </button>
                        <button class="theme-option" data-style="nordic">
                            <span class="theme-preview"></span>
                            <span>Minimal Nordic</span>
                        </button>
                        <button class="theme-option" data-style="industrial">
                            <span class="theme-preview"></span>
                            <span>Industrial Bold</span>
                        </button>
                        <button class="theme-option" data-style="soft">
                            <span class="theme-preview"></span>
                            <span>Soft Modern</span>
                        </button>
                    </div>
                </div>

                <button class="header-btn" id="btnToggleTheme" title="Dark Mode">
                    üåô
                </button>
                <button
                    class="header-btn"
                    id="btnFullscreen"
                    title="Fullscreen"
                >
                    ‚õ∂
                </button>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">Connessione...</span>
                </div>
            </div>
        </header>

        <!-- TOOLBAR -->
        <div class="toolbar" id="toolbar">
            <div class="search-bar">
                <span class="search-icon">üîç</span>
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Cerca work order..."
                    autocomplete="off"
                />
                <button class="search-clear hidden" id="searchClear">‚úï</button>
                <button class="btn-scan" id="btnScan" title="Scansiona barcode">
                    üì∑
                </button>
            </div>

            <div class="toolbar-controls">
                <div class="auto-refresh-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoRefreshToggle" />
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="control-label">Auto</span>
                    <select id="refreshInterval" class="refresh-select">
                        <option value="10">10s</option>
                        <option value="30" selected>30s</option>
                        <option value="60">1m</option>
                    </select>
                </div>
                <button class="toolbar-btn" id="btnRefresh" title="Aggiorna">
                    üîÑ <span class="btn-text">Aggiorna</span>
                </button>
            </div>

            <!-- Search Results -->
            <div class="search-results hidden" id="searchResults">
                <div class="search-results-header">
                    <span>Risultati</span>
                    <button class="btn-close-search" id="btnCloseSearch">
                        Chiudi
                    </button>
                </div>
                <div class="search-results-list" id="searchResultsList"></div>
            </div>
        </div>

        <!-- MAIN -->
        <main class="main-content">
            <!-- STEP 1: Workcenters -->
            <section class="step-section" id="stepWorkcenters">
                <h2 class="section-title">Seleziona Centro di Lavoro</h2>
                <div class="kanban-grid" id="workcenterGrid">
                    <div class="loading-placeholder">
                        <div class="spinner"></div>
                        <p>Caricamento...</p>
                    </div>
                </div>
            </section>

            <!-- STEP 2: Work Orders -->
            <section class="step-section hidden" id="stepWorkorders">
                <div class="section-header">
                    <div class="section-header-left">
                        <button class="btn-back" id="btnBack">
                            ‚Üê Indietro
                        </button>
                        <h2 class="section-title">
                            <span id="selectedWorkcenterName">-</span>
                            <span
                                class="workcenter-type-badge"
                                id="workcenterTypeBadge"
                            ></span>
                        </h2>
                    </div>

                    <!-- Filtri -->
                    <div class="filters">
                        <label
                            class="filter-toggle"
                            title="Mostra solo work orders compatibili con questo tipo di centro"
                        >
                            <input
                                type="checkbox"
                                id="filterCompatible"
                                checked
                            />
                            <span>Solo compatibili</span>
                        </label>
                        <label class="filter-toggle">
                            <input
                                type="checkbox"
                                id="filterCurrentWorkcenter"
                            />
                            <span>Solo questo centro</span>
                        </label>
                        <label class="filter-toggle">
                            <input type="checkbox" id="filterCompactView" />
                            <span>Compatto</span>
                        </label>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" id="tabActive">
                        üîÑ Attivi
                        <span class="tab-count" id="countActive">0</span>
                    </button>
                    <button class="tab" id="tabReady">
                        ‚è≥ Pronti
                        <span class="tab-count" id="countReady">0</span>
                    </button>
                </div>

                <div class="active-info" id="activeInfo">
                    <span id="activeInfoText"></span>
                </div>

                <!-- Tab Contents -->
                <div class="tab-content" id="tabContentActive">
                    <div class="kanban-grid" id="activeWorkorderGrid"></div>
                </div>
                <div class="tab-content hidden" id="tabContentReady">
                    <div class="kanban-grid" id="readyWorkorderGrid"></div>
                </div>
            </section>
        </main>

        <!-- MODAL AZIONE -->
        <div class="modal-overlay hidden" id="modalOverlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">Azione</h3>
                    <button class="modal-close" id="modalClose">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="modal-workorder-info">
                        <div class="info-row">
                            <span class="info-label">Work Order:</span>
                            <span class="info-value" id="modalWorkorderName"
                                >-</span
                            >
                        </div>
                        <div class="info-row">
                            <span class="info-label">Prodotto:</span>
                            <span class="info-value" id="modalProductName"
                                >-</span
                            >
                        </div>
                        <div class="info-row">
                            <span class="info-label">Operazione:</span>
                            <span class="info-value" id="modalOperationType"
                                >-</span
                            >
                        </div>
                        <div class="info-row">
                            <span class="info-label">Quantit√†:</span>
                            <span class="info-value" id="modalQty">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Centro attuale:</span>
                            <span class="info-value" id="modalCurrentWorkcenter"
                                >-</span
                            >
                        </div>
                        <div class="info-row hidden" id="modalDurationRow">
                            <span class="info-label">Tempo trascorso:</span>
                            <span class="info-value" id="modalDuration">-</span>
                        </div>
                    </div>

                    <!-- Selezione workcenter con pulsanti (quando avvio da ricerca) -->
                    <div
                        class="modal-workcenter-buttons hidden"
                        id="modalWorkcenterButtons"
                    >
                        <div class="workcenter-buttons-title">
                            Seleziona centro di lavoro:
                        </div>
                        <div
                            class="workcenter-buttons-grid"
                            id="workcenterButtonsGrid"
                        >
                            <!-- Pulsanti generati dinamicamente -->
                        </div>
                    </div>

                    <!-- Warning riassegnazione -->
                    <div
                        class="modal-warning hidden"
                        id="modalWorkcenterWarning"
                    >
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <span class="warning-text">
                            Verr√† riassegnato a
                            <strong id="modalTargetWorkcenter">-</strong>
                        </span>
                    </div>

                    <!-- Warning INCOMPATIBILIT√Ä (rosso) -->
                    <div
                        class="modal-error hidden"
                        id="modalIncompatibleWarning"
                    >
                        <span class="warning-icon">üö´</span>
                        <span class="warning-text">
                            <strong>ATTENZIONE:</strong> Questo √® un work order
                            di <strong id="modalWoOpType">-</strong> ma lo stai
                            assegnando a un centro di
                            <strong id="modalWcOpType">-</strong>!
                        </span>
                    </div>
                </div>
                <div class="modal-actions" id="modalActions"></div>
            </div>
        </div>

        <!-- MODAL SCANNER BARCODE -->
        <div class="modal-overlay hidden" id="scannerModalOverlay">
            <div class="modal modal-scanner">
                <div class="modal-header">
                    <h3 class="modal-title">Scansiona Barcode</h3>
                    <button class="modal-close" id="scannerModalClose">
                        ‚úï
                    </button>
                </div>
                <div class="modal-body">
                    <div id="scannerContainer"></div>
                    <p class="scanner-hint">
                        Posiziona il barcode al centro, a 15-20cm dalla
                        fotocamera
                    </p>
                </div>
            </div>
        </div>

        <!-- MODAL DETTAGLI / SCHEDA TECNICA -->
        <div class="modal-overlay hidden" id="detailsModalOverlay">
            <div class="modal modal-large modal-specs">
                <div class="modal-header">
                    <h3 class="modal-title">Scheda Tecnica</h3>
                    <span class="badge-changes hidden" id="specsChangesBadge"
                        >Modifiche non salvate</span
                    >
                    <button class="modal-close" id="detailsModalClose">
                        ‚úï
                    </button>
                </div>
                <div class="modal-body modal-body-scroll" id="specsModalBody">
                    <!-- Contenuto caricato dinamicamente -->
                    <div class="loading-placeholder" id="specsLoading">
                        <div class="spinner"></div>
                        <p>Caricamento scheda tecnica...</p>
                    </div>

                    <!-- SEZIONE INFO MO (nascosta inizialmente) -->
                    <div class="specs-content hidden" id="specsContent">
                        <div class="specs-info-section">
                            <!-- Riga 1: Ordine e Stato -->
                            <div class="specs-info-row">
                                <div class="info-cell">
                                    <span class="info-label">Ordine:</span>
                                    <span class="info-value" id="specsMoName"
                                        >-</span
                                    >
                                </div>
                                <div class="info-cell">
                                    <span class="info-label">Operazione:</span>
                                    <span class="info-value" id="specsOperation"
                                        >-</span
                                    >
                                </div>
                                <div class="info-cell info-cell-small">
                                    <span class="info-label">Stato:</span>
                                    <span class="state-badge" id="specsState"
                                        >-</span
                                    >
                                </div>
                            </div>

                            <!-- Riga 2: Prodotto (tutta la larghezza) -->
                            <div class="specs-info-row specs-info-row-full">
                                <div class="info-cell info-cell-full">
                                    <span class="info-label">Prodotto:</span>
                                    <span
                                        class="info-value click-to-edit"
                                        id="specsProductNameText"
                                        onclick="
                                            specsActivateEdit('productName')
                                        "
                                        >-</span
                                    >
                                    <input
                                        type="text"
                                        class="click-to-edit-input hidden"
                                        id="specsProductNameInput"
                                        onblur="
                                            specsSaveFieldEdit('productName')
                                        "
                                        onkeydown="
                                            specsHandleKeyDown(
                                                event,
                                                'productName',
                                            )
                                        "
                                    />
                                </div>
                            </div>

                            <!-- Riga 3: Quantit√† -->
                            <div class="specs-info-row">
                                <div class="info-cell">
                                    <span class="info-label">Quantit√†:</span>
                                    <span
                                        class="info-value click-to-edit"
                                        id="specsProductQtyText"
                                        onclick="
                                            specsActivateEdit('productQty')
                                        "
                                        >-</span
                                    >
                                    <input
                                        type="number"
                                        step="0.01"
                                        class="click-to-edit-input hidden"
                                        id="specsProductQtyInput"
                                        onblur="
                                            specsSaveFieldEdit('productQty')
                                        "
                                        onkeydown="
                                            specsHandleKeyDown(
                                                event,
                                                'productQty',
                                            )
                                        "
                                    />
                                    <span
                                        class="info-uom"
                                        id="specsProductUom"
                                    ></span>
                                </div>
                            </div>
                        </div>

                        <!-- SEZIONE SPECIFICHE TECNICHE -->
                        <div class="specs-section">
                            <h4>üìã Specifiche Tecniche</h4>
                            <table class="specs-table" id="specsTable">
                                <thead>
                                    <tr>
                                        <th>Tipo Macchina</th>
                                        <th>Chiave</th>
                                        <th>Valore</th>
                                        <th class="col-actions"></th>
                                    </tr>
                                </thead>
                                <tbody id="specsBody">
                                    <!-- Righe generate dinamicamente -->
                                </tbody>
                            </table>
                            <div class="specs-actions">
                                <button
                                    class="btn btn-sm btn-outline"
                                    onclick="specsAddNew()"
                                >
                                    + Aggiungi Specifica
                                </button>
                            </div>
                        </div>

                        <!-- SEZIONE COMPONENTI BOM -->
                        <div class="bom-section">
                            <h4>üì¶ Componenti (Distinta Base)</h4>
                            <table class="bom-table" id="bomTable">
                                <thead>
                                    <tr>
                                        <th>Prodotto</th>
                                        <th class="col-qty">Quantit√† %</th>
                                        <th class="col-actions"></th>
                                    </tr>
                                </thead>
                                <tbody id="bomBody">
                                    <!-- Righe generate dinamicamente -->
                                </tbody>
                            </table>
                            <div class="bom-total-row" id="bomTotalRow">
                                <span>Totale:</span>
                                <span class="bom-total-value" id="bomTotalValue"
                                    >0%</span
                                >
                            </div>
                            <div class="specs-actions">
                                <button
                                    class="btn btn-sm btn-outline"
                                    onclick="bomAddNew()"
                                >
                                    + Aggiungi Componente
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button
                        class="btn btn-success hidden"
                        id="btnSaveSpecs"
                        onclick="specsSaveAll()"
                    >
                        Salva Modifiche
                    </button>
                    <button class="btn btn-secondary" id="btnCloseDetails">
                        Chiudi
                    </button>
                </div>
            </div>
        </div>

        <!-- TOAST -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- App JS -->
        <script src="app.js"></script>
        
        <!-- Theme Selector JS -->
        <script>
            /**
             * =============================================
             * THEME SELECTOR - Gestione temi UI
             * =============================================
             * Permette di switchare tra 4 stili:
             * - default: Piduemme originale
             * - nordic: Minimal Nordic
             * - industrial: Industrial Bold
             * - soft: Soft Modern
             */
            
            (function() {
                'use strict';
                
                // === CONFIGURAZIONE TEMI ===
                const THEMES = {
                    default: { 
                        name: 'Originale', 
                        icon: 'üè≠',
                        themeColor: '#36a763'
                    },
                    nordic: { 
                        name: 'Minimal Nordic', 
                        icon: '‚ùÑÔ∏è',
                        themeColor: '#36a763'
                    },
                    industrial: { 
                        name: 'Industrial Bold', 
                        icon: 'üîß',
                        themeColor: '#1e2a38'
                    },
                    soft: { 
                        name: 'Soft Modern', 
                        icon: 'üå∏',
                        themeColor: '#36a763'
                    }
                };
                
                const STORAGE_KEY = 'piduemme-ui-style';
                
                // === ELEMENTI DOM ===
                const themeSelectorBtn = document.getElementById('themeSelectorBtn');
                const themeDropdown = document.getElementById('themeDropdown');
                const currentThemeName = document.getElementById('currentThemeName');
                const themeOptions = document.querySelectorAll('.theme-option');
                const themeColorMeta = document.querySelector('meta[name="theme-color"]');
                
                // === FUNZIONI ===
                
                /**
                 * Applica un tema all'interfaccia
                 * @param {string} styleName - Nome del tema (default, nordic, industrial, soft)
                 */
                function applyStyle(styleName) {
                    // Validazione
                    if (!THEMES[styleName]) {
                        console.warn(`Tema "${styleName}" non trovato, uso default`);
                        styleName = 'default';
                    }
                    
                    const theme = THEMES[styleName];
                    
                    // Applica data-style al body (o rimuovi per default)
                    if (styleName === 'default') {
                        document.body.removeAttribute('data-style');
                    } else {
                        document.body.setAttribute('data-style', styleName);
                    }
                    
                    // Aggiorna meta theme-color per PWA
                    if (themeColorMeta) {
                        themeColorMeta.setAttribute('content', theme.themeColor);
                    }
                    
                    // Aggiorna UI selettore
                    currentThemeName.textContent = theme.name;
                    
                    // Aggiorna stato attivo nelle opzioni
                    themeOptions.forEach(opt => {
                        opt.classList.toggle('active', opt.dataset.style === styleName);
                    });
                    
                    // Salva preferenza
                    localStorage.setItem(STORAGE_KEY, styleName);
                    
                    console.log(`üé® Tema applicato: ${theme.name}`);
                }
                
                /**
                 * Toggle visibilit√† dropdown
                 */
                function toggleDropdown() {
                    themeDropdown.classList.toggle('open');
                }
                
                /**
                 * Chiudi dropdown
                 */
                function closeDropdown() {
                    themeDropdown.classList.remove('open');
                }
                
                /**
                 * Carica tema salvato
                 */
                function loadSavedStyle() {
                    const saved = localStorage.getItem(STORAGE_KEY) || 'default';
                    applyStyle(saved);
                }
                
                // === EVENT LISTENERS ===
                
                // Click sul pulsante selettore
                themeSelectorBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleDropdown();
                });
                
                // Click su un'opzione tema
                themeOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const style = option.dataset.style;
                        applyStyle(style);
                        closeDropdown();
                    });
                });
                
                // Chiudi dropdown cliccando fuori
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.theme-selector')) {
                        closeDropdown();
                    }
                });
                
                // Chiudi con ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeDropdown();
                    }
                });
                
                // === INIZIALIZZAZIONE ===
                loadSavedStyle();
                
                // Esponi API globale per debug
                window.ThemeSelector = {
                    apply: applyStyle,
                    themes: THEMES
                };
                
            })();
        </script>
    </body>
</html>
